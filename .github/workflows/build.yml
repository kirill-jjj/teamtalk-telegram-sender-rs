name: Build Binaries

permissions:
  contents: write

on:
  push:
    branches: [ "main" ]
    tags: [ "v*.*.*" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  SQLX_OFFLINE: true
  SCCACHE_GHA_ENABLED: "true"
  RUSTC_WRAPPER: sccache

jobs:
  checks:
    name: Lint & Test (Linux)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable

      - name: Rust Cache
        uses: swatinem/rust-cache@v2
        with:
          cache-targets: false

      - name: sccache
        uses: mozilla-actions/sccache-action@v0.0.9

      - name: Install sqlx-cli (sqlite)
        run: cargo install sqlx-cli --no-default-features --features sqlite

      - name: SQLx Migrations (online)
        env:
          SQLX_OFFLINE: "false"
          DATABASE_URL: sqlite://ci.db
        run: |
          cargo sqlx database create
          cargo sqlx migrate run

      - name: SQLx Prepare (offline data)
        env:
          SQLX_OFFLINE: "false"
          DATABASE_URL: sqlite://ci.db
        run: cargo sqlx prepare

      - name: Cargo Check
        run: cargo check

      - name: Cargo Clippy
        run: cargo clippy --all-targets --all-features -- -D warnings

      - name: Cargo Test
        run: cargo test

      - name: Cargo Fmt
        run: cargo fmt --check

      - name: sccache Stats
        run: sccache --show-stats

  build:
    name: Build for ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    needs: checks
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            artifact_name: teamtalk-telegram-sender-linux
            bin_name: teamtalk-telegram-sender-rs
            asset_name: teamtalk-telegram-sender-rs-linux.tar.gz
          - os: windows-latest
            artifact_name: teamtalk-telegram-sender-windows
            bin_name: teamtalk-telegram-sender-rs.exe
            asset_name: teamtalk-telegram-sender-rs-windows.zip

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Check version consistency
        if: startsWith(github.ref, 'refs/tags/')
        shell: bash
        run: |
          CARGO_VERSION=$(grep "^version" Cargo.toml | head -n 1 | cut -d '"' -f 2)
          TAG_VERSION=${GITHUB_REF#refs/tags/v}
          if [ "$CARGO_VERSION" != "$TAG_VERSION" ]; then
            echo "Error: Cargo.toml version ($CARGO_VERSION) does not match Tag ($TAG_VERSION)"
            exit 1
          fi

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable

      - name: Rust Cache
        uses: swatinem/rust-cache@v2
        with:
          cache-targets: false

      - name: sccache
        uses: mozilla-actions/sccache-action@v0.0.9

      - name: Build Release
        run: cargo build --release --verbose

      - name: sccache Stats
        run: sccache --show-stats

      - name: Prepare Artifacts
        shell: bash
        run: |
          mkdir payload
          if [ "${{ matrix.os }}" = "windows-latest" ]; then
            cp target/release/${{ matrix.bin_name }} payload/${{ matrix.bin_name }}
          else
            cp target/release/${{ matrix.bin_name }} payload/${{ matrix.bin_name }}
          fi
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            cp config.toml.example payload/config.toml.example
          fi

      - name: Create Archive
        if: startsWith(github.ref, 'refs/tags/')
        shell: bash
        run: |
          cd payload
          if [ "${{ matrix.os }}" = "windows-latest" ]; then
            7z a ../${{ matrix.asset_name }} *
          else
            tar -czvf ../${{ matrix.asset_name }} *
          fi

      - name: Upload Artifacts
        uses: actions/upload-artifact@v6
        with:
          name: ${{ matrix.artifact_name }}
          path: payload/

      - name: Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: ${{ matrix.asset_name }}
